function BibtexParser(){this.pos=0,this.input="",this.entries={},this.comments=[],this.strings={JAN:"January",FEB:"February",MAR:"March",APR:"April",MAY:"May",JUN:"June",JUL:"July",AUG:"August",SEP:"September",OCT:"October",NOV:"November",DEC:"December"},this.currentKey="",this.currentEntry="",this.setInput=function(a){this.input=a},this.getEntries=function(){return this.entries},this.isWhitespace=function(a){return" "==a||"\r"==a||"\t"==a||"\n"==a},this.match=function(a){if(this.skipWhitespace(),this.input.substring(this.pos,this.pos+a.length)!=a)throw"Token mismatch, expected "+a+", found "+this.input.substring(this.pos);this.pos+=a.length,this.skipWhitespace()},this.tryMatch=function(a){return this.skipWhitespace(),this.input.substring(this.pos,this.pos+a.length)==a},this.skipWhitespace=function(){for(;this.isWhitespace(this.input[this.pos]);)this.pos++;if("%"==this.input[this.pos]){for(;"\n"!=this.input[this.pos];)this.pos++;this.skipWhitespace()}},this.value_braces=function(){var a=0;this.match("{");for(var b=this.pos;;){if("}"==this.input[this.pos]&&"\\"!=this.input[this.pos-1]){if(!(a>0)){var c=this.pos;return this.match("}"),this.input.substring(b,c)}a--}else if("{"==this.input[this.pos])a++;else if(this.pos==this.input.length-1)throw"Unterminated value";this.pos++}},this.value_quotes=function(){this.match('"');for(var a=this.pos;;){if('"'==this.input[this.pos]&&"\\"!=this.input[this.pos-1]){var b=this.pos;return this.match('"'),this.input.substring(a,b)}if(this.pos==this.input.length-1)throw"Unterminated value:"+this.input.substring(a);this.pos++}},this.single_value=function(){var a=this.pos;if(this.tryMatch("{"))return this.value_braces();if(this.tryMatch('"'))return this.value_quotes();var b=this.key();if(this.strings[b.toUpperCase()])return this.strings[b];if(b.match("^[0-9]+$"))return b;throw"Value expected:"+this.input.substring(a)},this.value=function(){var a=[];for(a.push(this.single_value());this.tryMatch("#");)this.match("#"),a.push(this.single_value());return a.join("")},this.key=function(){for(var a=this.pos;;){if(this.pos==this.input.length)throw"Runaway key";if(!this.input[this.pos].match("[a-zA-Z0-9_:\\./-]"))return this.input.substring(a,this.pos).toUpperCase();this.pos++}},this.key_equals_value=function(){var a=this.key();if(this.tryMatch("=")){this.match("=");var b=this.value();return[a,b]}throw"... = value expected, equals sign missing:"+this.input.substring(this.pos)},this.key_value_list=function(){var a=this.key_equals_value();for(this.entries[this.currentEntry][a[0]]=a[1];this.tryMatch(",")&&(this.match(","),!this.tryMatch("}"));)a=this.key_equals_value(),this.entries[this.currentEntry][a[0]]=a[1]},this.entry_body=function(a){this.currentEntry=this.key(),this.entries[this.currentEntry]={entryType:a.substring(1)},this.match(","),this.key_value_list()},this.directive=function(){return this.match("@"),"@"+this.key()},this.string=function(){var a=this.key_equals_value();this.strings[a[0].toUpperCase()]=a[1]},this.preamble=function(){this.value()},this.comment=function(){for(var a=this.pos;;){if(this.pos==this.input.length)throw"Runaway comment";if("}"==this.input[this.pos])return void this.comments.push(this.input.substring(a,this.pos));this.pos++}},this.entry=function(a){this.entry_body(a)},this.bibtex=function(){for(;this.tryMatch("@");){var a=this.directive().toUpperCase();this.match("{"),"@STRING"==a?this.string():"@PREAMBLE"==a?this.preamble():"@COMMENT"==a?this.comment():this.entry(a),this.match("}")}this.entries["@comments"]=this.comments}}function doParse(a){var b=new BibtexParser;return b.setInput(a),b.bibtex(),b.entries}function textohtml(a){for(var b in textohtml_map)textohtml_map.hasOwnProperty(b)&&(a=a.replace("{"+b+"}",textohtml_map[b]),a=a.replace(b,textohtml_map[b]));return a}function replace_html(a,b){var c=$("p").filter(function(){return a.test($(this).text())});$.each(c,function(){var c=$(this).html();$(this).html(c.replace(a,b))})}var textohtml_map={'\\"u':"&uuml;",'\\"a':"&auml;",'\\"o':"&ouml;","\\'e":"&eacute;","\\'a":"&aacute;",'\\"U':"&Uuml;",'\\"A':"&Auml;",'\\"O':"&Ouml;","\\'E":"&Eacute;","\\'A":"&Aacute;",'\\"{u}':"&uuml;",'\\"{a}':"&auml;",'\\"{o}':"&ouml;","\\'{e}":"&eacute;","\\'{a}":"&aacute;",'\\"{U}':"&Uuml;",'\\"{A}':"&Auml;",'\\"{O}':"&Ouml;","\\'{E}":"&Eacute;","\\'{A}":"&Aacute;","\\&":"&amp;"},referenceCounts={},referenceCount=function(a){var b="string"==typeof a?a:a._ID;return referenceCounts[b]=(referenceCounts[b]||0)+1,referenceCounts[b]},parseAuthor=function(a){var b=a.split(" and ");return b.map(function(a){var b={full:a},c=a.split(", ");return b.lastName=c[0],c=c[1].split(" "),b.firstName=c[0],b.middleNames=c.slice(1),b.initials=[b.firstName[0]],_(b.middleNames).each(function(a){b.initials.push(a[0])}),b})},formatAuthors=function(a,b,c){void 0==b&&(b=!1),void 0==c&&(c=!1);var d=parseAuthor(a.AUTHOR).map(function(a){return c?a.lastName+", "+a.initials.join(". ")+".":a.lastName});return 1==d.length?d[0]:d.length<=5&&1==b||2==d.length?d.slice(0,d.length-1).join(", ")+" & "+d[d.length-1]:d[0]+" et al."},templates={fullArticle:_.template('<%= authors %> (<%= year %>). <%= title %><%= title ? "." : "" %> <em><%= journal %></em><%= journal ? "." : "" %> <%= volume %><% if (number) { %><em>(<%= number %>)</em><% } %><%= (pages && volume ) ? ": " : "" %><%= pages %><%= pages ? "." : "" %>'),citep:_.template('(<%= before %><%= before ? " " : "" %><a href="#<%= id %>" rel="footnote"><%= authors %>, <%= year %></a><%= after ? " " : "" %><%= after %>)'),citet:_.template('<a href="#<%= id %>" rel="footnote"><%= authors %> (<%= before %><%= before ? " " : "" %><%= year %><%= after ? " " : "" %><%= after %>)</a>')},fnSelector="div.footnotes ol",fnCounter=0,fullReference=function(a,b,c,d){var e=$('<div id="'+a+'" class="footnote-wrapper"></div>').append($("<p></p>").html(c)).append(fullcite(b)).append($("<p></p>").html(d));return $("<div>").append(e).html()},citep=function(a,b,c){var d=referenceCount(a);fnCounter++;var e="footcite-"+fnCounter,f=templates.citep({authors:formatAuthors(a,d%5==1,!1),year:a.YEAR,count:d,id:e,before:b,after:c});return f+fullReference(e,a)},citet=function(a,b,c){var d=referenceCount(a);fnCounter++;var e="footcite-"+fnCounter,f=templates.citet({authors:formatAuthors(a,d%5==1,!1),year:a.YEAR,count:d,id:e,before:b,after:c});return f+fullReference(e,a)},footcite=function(a,b,c){fnCounter++;var d="footcite-"+fnCounter,e='<sup class="footnote"><a href="#'+d+'" rel="footnote">'+fnCounter+"</a></sup>";return e+fullReference(d,a,b,c)},fullcite=function(a,b,c){return templates.fullArticle({authors:formatAuthors(a,!0,!1),year:a.YEAR,title:a.TITLE.slice(1,a.TITLE.length-2),journal:a.JOURNAL,volume:a.VOLUME,number:a.NUMBER,pages:a.PAGES.replace("--","&ndash;")})},updateReference=function(a,b){var c=new RegExp("@(.)?"+b,"i"),d=$("p").filter(function(){return c.test($(this).text())}),c=new RegExp("@(.)?"+b+"\\)?(\\[.*\\])*","gi");$.each(d,function(){var b=$(this).html(),d=b.replace(c,function(b,c,d){var c=c,e="",f="",g=citet;return d&&(d=d.slice(1,d.length-1).split("]["),e=d[0],f=d[1]||""),"("==c?g=citep:"^"==c?g=footcite:"@"==c&&(g=fullcite),g(a,e,f)});$(this).html(textohtml(d))})};$(function(){$.get("/assets/bibliography.bib",function(a){$(function(){var b=doParse(a);_(b).each(function(a,b){a._ID=b,updateReference(a,b)}),$(".footnote-wrapper").each(function(a,b){var c=$(b),d=$('<div class="content"></div>').html(c.html()),e=$('<div class="tip"></div>');c.empty().append(d).prepend(e)}),$("a[rel='footnote'], a.footnote").map(function(a,b){var c=$(b);$(c.attr("href"));c.on("click",function(a){a.preventDefault();var b=c.attr("href"),d=$(b),e=d.hasClass("active");if(e)d.removeClass("visible"),d.data("timeout",setTimeout(function(){d.removeClass("active")},300));else{$(".footnote-wrapper.active").each(function(){var a=$(this);a.removeClass("visible"),a.data("timeout",setTimeout(function(){a.removeClass("active")},300))}),d.addClass("active"),clearTimeout(d.data("timeout")),d.data("timeout",setTimeout(function(){d.addClass("visible")},10));var f=$("<i>").insertBefore(c).addClass("probe"),g=f.position(),h=$("<i>").insertAfter(c).addClass("probe"),i=h.position();h.remove(),f.remove(),i.top-g.top>10&&g.top>=0?(refWidth=i.left,refLeft=0,refTop=g.top+c.height()):(refWidth=c.width(),refLeft=g.left,refTop=i.top+c.height());var j=$("main").width(),k=d.width();refLeft>j-k/2?targetLeft=j-k:(targetLeft=refLeft-(k-refWidth)/2,targetLeft=Math.max(0,targetLeft)),d.css({left:targetLeft,top:refTop});var l=d.find(".tip"),m=refLeft+refWidth/2,n=targetLeft+k/2;m!=n&&l.css("left",m-targetLeft)}})})})})});
//# sourceMappingURL=bibcite.min.js.map