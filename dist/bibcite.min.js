function BibtexParser(){this.pos=0,this.input="",this.entries={},this.comments=[],this.strings={JAN:"January",FEB:"February",MAR:"March",APR:"April",MAY:"May",JUN:"June",JUL:"July",AUG:"August",SEP:"September",OCT:"October",NOV:"November",DEC:"December"},this.currentKey="",this.currentEntry="",this.setInput=function(a){this.input=a},this.getEntries=function(){return this.entries},this.isWhitespace=function(a){return" "==a||"\r"==a||"\t"==a||"\n"==a},this.match=function(a){if(this.skipWhitespace(),this.input.substring(this.pos,this.pos+a.length)!=a)throw"Token mismatch, expected "+a+", found "+this.input.substring(this.pos);this.pos+=a.length,this.skipWhitespace()},this.tryMatch=function(a){return this.skipWhitespace(),this.input.substring(this.pos,this.pos+a.length)==a},this.skipWhitespace=function(){for(;this.isWhitespace(this.input[this.pos]);)this.pos++;if("%"==this.input[this.pos]){for(;"\n"!=this.input[this.pos];)this.pos++;this.skipWhitespace()}},this.value_braces=function(){var a=0;this.match("{");for(var b=this.pos;;){if("}"==this.input[this.pos]&&"\\"!=this.input[this.pos-1]){if(!(a>0)){var c=this.pos;return this.match("}"),this.input.substring(b,c)}a--}else if("{"==this.input[this.pos])a++;else if(this.pos==this.input.length-1)throw"Unterminated value";this.pos++}},this.value_quotes=function(){this.match('"');for(var a=this.pos;;){if('"'==this.input[this.pos]&&"\\"!=this.input[this.pos-1]){var b=this.pos;return this.match('"'),this.input.substring(a,b)}if(this.pos==this.input.length-1)throw"Unterminated value:"+this.input.substring(a);this.pos++}},this.single_value=function(){var a=this.pos;if(this.tryMatch("{"))return this.value_braces();if(this.tryMatch('"'))return this.value_quotes();var b=this.key();if(this.strings[b.toUpperCase()])return this.strings[b];if(b.match("^[0-9]+$"))return b;throw"Value expected:"+this.input.substring(a)},this.value=function(){var a=[];for(a.push(this.single_value());this.tryMatch("#");)this.match("#"),a.push(this.single_value());return a.join("")},this.key=function(){for(var a=this.pos;;){if(this.pos==this.input.length)throw"Runaway key";if(!this.input[this.pos].match("[a-zA-Z0-9_:\\./-]"))return this.input.substring(a,this.pos).toUpperCase();this.pos++}},this.key_equals_value=function(){var a=this.key();if(this.tryMatch("=")){this.match("=");var b=this.value();return[a,b]}throw"... = value expected, equals sign missing:"+this.input.substring(this.pos)},this.key_value_list=function(){var a=this.key_equals_value();for(this.entries[this.currentEntry][a[0]]=a[1];this.tryMatch(",")&&(this.match(","),!this.tryMatch("}"));)a=this.key_equals_value(),this.entries[this.currentEntry][a[0]]=a[1]},this.entry_body=function(a){this.currentEntry=this.key(),this.entries[this.currentEntry]={entryType:a.substring(1)},this.match(","),this.key_value_list()},this.directive=function(){return this.match("@"),"@"+this.key()},this.string=function(){var a=this.key_equals_value();this.strings[a[0].toUpperCase()]=a[1]},this.preamble=function(){this.value()},this.comment=function(){for(var a=this.pos;;){if(this.pos==this.input.length)throw"Runaway comment";if("}"==this.input[this.pos])return void this.comments.push(this.input.substring(a,this.pos));this.pos++}},this.entry=function(a){this.entry_body(a)},this.bibtex=function(){for(;this.tryMatch("@");){var a=this.directive().toUpperCase();this.match("{"),"@STRING"==a?this.string():"@PREAMBLE"==a?this.preamble():"@COMMENT"==a?this.comment():this.entry(a),this.match("}")}this.entries["@comments"]=this.comments}}function doParse(a){var b=new BibtexParser;return b.setInput(a),b.bibtex(),b.entries}function tex2html(a){for(var b in textohtml_map)textohtml_map.hasOwnProperty(b)&&(a=a.replace("{"+b+"}",textohtml_map[b]),a=a.replace(b,textohtml_map[b]));return a}var CitationStyle=function(a){if(!(this instanceof CitationStyle))return new CitationStyle(a);this.footnote=0,this.options=_.defaults(a||{},{before:"",after:"",includeFootnote:!1,plain:!0,showAllAuthorsEvery:3,footnoteIdTemplate:"bibcite-<%= footnoteNo %>"}),this.options.footnoteIdTemplate=_.template(this.options.footnoteIdTemplate),this.options._export=!0,this.options._triggerCite=!0;var b="address annote author booktitle chapter crossref edition editor howpublished institution journal key month note number organization pages publisher school series title type volume year";this.fields=b.split(" ")};CitationStyle.prototype.templates={fullArticle:_.template('<%= author %> (<%= year %>). <%= title %><%= title ? "." : "" %> <em><%= journal %></em><%= journal ? "." : "" %> <%= volume %><% if (number) { %><em>(<%= number %>)</em><% } %><%= (pages && volume ) ? ": " : "" %><%= pages %><%= pages ? "." : "" %>'),fullBook:_.template('<%= author %> (<%= year %>). <em><%= title %><%= title ? "." : "" %></em> <%= address %><%= address ? ":" : "" %> <%= publisher %>.'),citep_plain:_.template('(<%= before %><%= before ? " " : "" %><%= author %>, <%= year %><%= after ? " " : "" %><%= after %>)'),citep:_.template('(<%= before %><%= before ? " " : "" %><a href="#<%= footnoteId %>" rel="footnote"><%= author %>, <%= year %></a><%= after ? " " : "" %><%= after %>)'),citet:_.template('<a href="#<%= footnoteId %>" rel="footnote"><%= author %> (<%= before %><%= before ? " " : "" %><%= year %><%= after ? " " : "" %><%= after %>)</a>'),citet_plain:_.template('<%= author %> (<%= before %><%= before ? " " : "" %><%= year %><%= after ? " " : "" %><%= after %>)'),footcite:_.template('<sup class="footnote"><a href="#<%= footnoteId %>" rel="footnote"><%= footnote %></a></sup>'),footnote:_.template('<div id="<%= footnoteId %>" class="bibcite-footnote-wrapper"><div class="tip"></div><div class="content"><%= before ? "<p>" : ""%><%= before %><%= before ? "</p>" : ""%><p><%= content %></p><%= after ? "<p>" : ""%><%= after %><%= after ? "</p>" : ""%></div></div>')},CitationStyle.prototype.formatAuthors=function(a,b,c){void 0==b&&(b=!1),void 0==c&&(c=!1);var d=a.get("author").map(function(a){return c?a.lastName+", "+a.initials.join(". ")+".":a.lastName});return 1==d.length?d[0]:d.length<=6&&1==b||2==d.length?d.slice(0,d.length-1).join(", ")+" & "+d[d.length-1]:d[0]+" et al."},CitationStyle.prototype.nextFn=function(){return this.footnote++,this.footnote},CitationStyle.prototype.export=function(a,b){var c={};for(i in this.fields){var d=this.fields[i];switch(d){case"author":switch(b){case"reference":val=this.formatAuthors(a,!0,!0);break;case"inline":var e=a.get("count")%this.options.showAllAuthorsEvery==0;val=this.formatAuthors(a,e,!1)}break;case"title":var f=a.get("title");val=f.slice(1,f.length-1);break;default:val=a.get(d)}c[d]=val||""}return c.key=a.get("key"),c.footnote=this.nextFn(),c.footnoteId=this.options.footnoteIdTemplate({footnoteNo:c.footnote}),c},CitationStyle.prototype.render=function(a,b,c){var c=_.defaults(c||{},this.options),d=c;c._export&&(d=_(this.export(b,c._context)).defaults(c)),c._triggerCite&&b.cite(),c.includeFootnote&&(c.plain=!1),c.plain&&a+"_plain"in this.templates&&(a+="_plain");var e=this.templates[a](d);if("footnote"!=c._context&&(c.before="",c.after=""),c.includeFootnote){var f=_.extend(d,{includeFootnote:!1,_export:!1,_triggerCite:!1}),g=this.fullcite(b,f),h=this.templates.footnote(_(f).extend({content:g}));return{citation:e,footnote:h}}return e},CitationStyle.prototype.citep=function(a,b){return b=_(b).defaults({_context:"inline"}),this.render("citep",a,b)},CitationStyle.prototype.citet=function(a,b){return b=_(b).defaults({_context:"inline"}),this.render("citet",a,b)},CitationStyle.prototype.footcite=function(a,b){return b=_(b).defaults({_context:"footnote"}),this.render("footcite",a,b)},CitationStyle.prototype.fullcite=function(a,b){switch(b=_.defaults(b||{},{includeFootnote:!1,_context:"reference"}),a.get("entryType")){case"BOOK":return this.render("fullBook",a,b);default:return this.render("fullArticle",a,b)}};var textohtml_map={'\\"u':"&uuml;",'\\"a':"&auml;",'\\"o':"&ouml;","\\'e":"&eacute;","\\'a":"&aacute;",'\\"U':"&Uuml;",'\\"A':"&Auml;",'\\"O':"&Ouml;","\\'E":"&Eacute;","\\'A":"&Aacute;",'\\"{u}':"&uuml;",'\\"{a}':"&auml;",'\\"{o}':"&ouml;","\\'{e}":"&eacute;","\\'{a}":"&aacute;",'\\"{U}':"&Uuml;",'\\"{A}':"&Auml;",'\\"{O}':"&Ouml;","\\'{E}":"&Eacute;","\\'{A}":"&Aacute;","\\&":"&amp;","--":"&ndash;"},BibCite=function(a,b){if(!(this instanceof BibCite))return new BibCite(b);this.options=_.defaults(b||{},{bibfile:a,defaultMode:"t",selector:"p, li",includeFootnote:!0}),this.style=new CitationStyle(this.options),this.bibliography={};var c=this;$.ajax({url:a,success:function(a){var b=doParse(a);for(key in b)if("@comments"!=key){var d=new Citation(key,b[key]);c.bibliography[key.toUpperCase()]=d}},async:!1})};BibCite.prototype.replace=function(){for(key in this.bibliography)this.replaceCitation(this.bibliography[key]);this.updateTooltips()},BibCite.prototype.replaceCitation=function(a){a=this.get(a);var b=new RegExp("@(.)?"+a.get("key"),"i"),c=$(this.options.selector).filter(function(){return b.test($(this).text())}),d=this,b=new RegExp("(@{1,2})(.)?"+a.get("key")+"\\)?((\\{[^\\{]*\\})*)","gi");$.each(c,function(){var c=$(this).html(),e=c.replace(b,function(b,c,e,f,g,h,i){var e=e,j=d.options.defaultMode,k={},l=2==c.length;k.includeFootnote=!!l,f&&(f=f.slice(1,f.length-1).split("}{"),k.before=f[0],k.after=f[1]||""),"("==e?j="p":"^"==e?(j="foot",k.includeFootnote=!0):"*"==e&&(j="full");var m=d.cite(a,j,k);return"object"==typeof m?m.citation+m.footnote:m});$(this).html(tex2html(e))})},BibCite.prototype.get=function(a){if(_.isString(a))return a in this.bibliography?this.bibliography[a.toUpperCase()]:(console.warn("Citation key not found"),!1);if(Citation.prototype.isPrototypeOf(a))return a;throw"Error: Bibcite.get only accepts strings or citation elements"},BibCite.prototype.cite=function(a,b,c){if(_.isString(a)&&(a=this.get(a),_.isUndefined(a)))throw"Error: Citation key not found";if(!Citation.prototype.isPrototypeOf(a))throw"Error: citation should have Citation as a prototype";_.isObject(b)&&(c=b,b=this.options.defaultMode);var d={t:"citet",p:"citep",full:"fullcite",foot:"footcite"},b=b||this.options.defaultMode;b in d||(console.warn('Warning: invalid mode argument: expecting "t", "p", or "full", but got "'+b+'". Assuming default.'),b=this.options.defaultMode);var e=d[b];return this.style[e].apply(this.style,[a,c])},BibCite.prototype.citep=function(a,b){return this.cite(a,"p",b)},BibCite.prototype.citet=function(a,b){return this.cite(a,"t",b)},BibCite.prototype.fullcite=function(a,b){return this.cite(a,"full",b)},BibCite.prototype.footcite=function(a,b){return this.cite(a,"foot",b)},BibCite.prototype.updateTooltips=function(){$("a[rel='footnote'], a.footnote").map(function(a,b){var c=$(b);$(c.attr("href"));c.on("click",function(a){a.preventDefault();var b=c.attr("href"),d=$(b),e=d.hasClass("active");if(e)d.removeClass("visible"),d.data("timeout",setTimeout(function(){d.removeClass("active")},300));else{$(".bibcite-footnote-wrapper.active").each(function(){var a=$(this);a.removeClass("visible"),a.data("timeout",setTimeout(function(){a.removeClass("active")},300))}),d.addClass("active"),clearTimeout(d.data("timeout")),d.data("timeout",setTimeout(function(){d.addClass("visible")},10));var f=$("<i>").insertBefore(c).addClass("probe"),g=f.position(),h=$("<i>").insertAfter(c).addClass("probe"),i=h.position();h.remove(),f.remove(),i.top-g.top>10&&g.top>=0?(refWidth=i.left,refLeft=0,refTop=g.top+c.height()):(refWidth=c.width(),refLeft=g.left,refTop=i.top+c.height());var j=$("main").width(),k=d.width();refLeft>j-k/2?targetLeft=j-k:(targetLeft=refLeft-(k-refWidth)/2,targetLeft=Math.max(0,targetLeft)),d.css({left:targetLeft,top:refTop});var l=d.find(".tip"),m=refLeft+refWidth/2,n=targetLeft+k/2;m!=n&&l.css("left",m-targetLeft)}})})},BibCite.prototype.references=function(a){var b=_.filter(this.bibliography,function(a){return a.get("count")>0});b=_.sortBy(b,function(a){return this.style.formatAuthors(a,!0,!0)}.bind(this));var c=$('<ul class="references"></ul>');return _.each(b,function(a){var b=tex2html(this.fullcite(a)),d=$("<li></li>").html(b);d.appendTo(c)}.bind(this)),a?void c.appendTo($(a)):c};var Citation=function(a,b){return this instanceof Citation?(this.key=a,this.bib=b,this.count=0,void this.parseAuthor()):new Citation(citation_id,citation)};Citation.prototype.get=function(a){return a in this?this[a]:a.toUpperCase()in this.bib&&this.bib[a.toUpperCase()]},Citation.prototype.parseAuthor=function(){var a=this.get("author");if(!a)return!1;var b=a.split(" and ");this.author=b.map(function(a){var b={full:a},c=a.split(", ");return b.lastName=c[0],c=c[1].split(" "),b.firstName=c[0],b.middleNames=c.slice(1),b.initials=[b.firstName[0]],$(b.middleNames).each(function(a){b.initials.push(a[0])}),b.initials=_.map(b.initials,function(a){return _.isUndefined(a)?"":a.charAt(0).toUpperCase()+a.slice(1)}),b})},Citation.prototype.cite=function(){this.count++};
//# sourceMappingURL=bibcite.min.js.map